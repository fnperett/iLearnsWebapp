<script src="scripts/global.js"></script>

<!-- <html>
    <div class="page_headder">
        <div>
            <h1 style="font-family: cursive;">iLearns</h1>
            <div class="title">
                <t style="font-size: 100px;">
                    Ionic Compound
                </t>
            </div>
        </div>
    </div>
    <div class="page_body">
        <div>
            <button class="select_button">
                Select Element
            </button>
        </div>
    </div>
    <div class="page_footer">
        <button onclick="getRootPage();">
            <img src="/images_usage/back.png" style="width: -webkit-fill-available;">
        </button>
    </div>
</html> -->




<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <div class="title-container">
        <h2 id = "title">Ionic Compound</h2>
    
        <div class="page_headder">
          <h1 class="multicolor-word">
              <span style="color: red;">i</span>
              <span style="color: orange;">L</span>
              <span style="color: yellow;">e</span>
              <span style="color: rgb(72, 255, 72);">a</span>
              <span style="color: rgb(0, 229, 255);">r</span>
              <span style="color: blue;">n</span>
              <span style="color: purple;">s</span>
          </h1>
        </div>
      </div>
    <div class="page_body">
        <div>
            <title>Interlocking Blocks</title>
            <!-- <div class="controls">
                <button onclick="addBlock('left')">Add Left Block</button>
                <button onclick="addBlock('right')">Add Right Block</button>
            </div> -->
            
            <div class="container">
                <div id="left-list" class="list left"></div>
                <div id="right-list" class="list right"></div>
            </div>
        </div>
        <h1 id =neutralized>Neutralized</h1>
    </div>
    <div class="page_footer">
        <button onclick="getRootPage();">
            <img src="/images_usage/back.png" style="width: -webkit-fill-available;">
        </button>
    </div>
</head>


<body>

    <style>
        .page_headder {
            position:relative;
            height: 5%;
            top: -50%;
            left: 1%; 
            width: 100%;
            font-size: 24px;
            font-family: cursive;
            letter-spacing: -20px;
            word-spacing: 0;
            text-shadow: 
                -1px -1px 0 #000,  
                1px -1px 0 #000,
                -1px  1px 0 #000,
                1px  1px 0 #000; /* Border color */
        }
        .page_headder span {
            display: inline;
            letter-spacing: 0; /* Ensures no additional spacing */
        }
        .title{
            text-align: center;
        }
        .page_body{
            height: 80%;
            text-align: center;
            align-content: center;
        }
    
        .select_button{
            height: 30%;
            width: 40%;
            text-align: center;
        }
    
        .page_footer button{
            height: 75px;
            width: 75px;
            position: absolute;
            left: 50;
            bottom: 20;
            padding: 10px;
            z-index: 1;
        }

        body {
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            height: 100vh;
            background-color: #87c795;
        }
        .title-container {
            width: 100%;
            height: 50vh;
            padding: 30px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            z-index: 1;
            font-size: 60px;
            top: -130px;
        }   
        .list {
            display: flex;
            flex-direction: column;
            top: 0px;
        }
        .block {
            width: 150px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 24px;
            padding: 10px;
            box-sizing: border-box;
            margin: 2px 0;
            transition: all 0.2s ease-in-out;
        }
        .left .block {
            background-color: #4A90E2;
        }
        .right .block {
            background-color: #e24a4a;
        }
        /* .selected {
            animation: pulse 1s infinite alternate;
            filter: drop-shadow(0px 0px 5px red);
        } */
        /* @keyframes pulse {
            
        } */
        .selected {
            border: 4px solid rgb(0, 255, 47);
            animation: pulse 1s infinite alternate;
        }
        @keyframes pulse {
            0% { border-color: rgb(0, 255, 47); }
            100% { border-color: rgba(255, 255, 255, 0); }
        }
        .controls {
            margin-bottom: 20px;
            top: -250px;
            position: relative;
        }
        .container {
            display: flex;
            align-items: flex-start;
            gap: 20px;
            position: relative;
            top: -250px;
        }
        #title {
            position: relative;
            font-size: 100px;
            color: rgb(0, 0, 0);
            text-shadow: 1px 1px 4px rgb(255, 255, 255);
            top: 50px;
        }
        #neutralized {
            position: relative;
            font-size: 80px;
            color: rgb(0, 0, 0);
            text-shadow: 1px 1px 4px rgb(255, 255, 255);
            top: -50px;
            animation: pulse1 3s infinite;
            visibility: hidden;
        } 
        @keyframes pulse1 {
            0%, 100% {
                transform: scale(1);
                opacity: 1;
            }
            50% {
                transform: scale(1.2);
                opacity: 0.8;
            }
        }
    </style>
    

<script>
    let selectedBlock = null;
    let selectedSide = "left";
    // let leftElement = "";
    // let leftOxidationIndex = 0;
    // let leftList = [];
    // let rightElement = "";
    // let rightOxidationIndex = 0;
    // let rightList = [];
    
    // Name, Oxidation Index, List of Oxidation States
    let leftElement = [];
    let rightElement = [];

    function generateBlock(size, side, elementName) {
        const block = document.createElement('div');
        block.className = 'block';
        block.dataset.size = size;
        block.dataset.side = side;
        block.dataset.elementName = elementName
        block.style.height = `${(60 * size) + ((size * size) / 2.5)}px`;
        block.style.width = '200px';
        block.innerText = side === 'left' ? `${elementName} +${size}` : `${elementName} -${size}`;
        block.style.clipPath = side === 'left' ? generateLeftClipPath(size) : generateRightClipPath(size);
        return block;
    }
    
    function generateLeftClipPath(size) {
        let points = ['0 0', '85% 0'];
        for (let i = 0; i < size; i++) {
            let y1 = (i / size) * 100;
            let y2 = ((i + 0.5) / size) * 100;
            let y3 = ((i + 1) / size) * 100;
            points.push(`100% ${y1}%`, `85% ${y2}%`, `100% ${y3}%`);
        }
        points.push('0 100%');
        return `polygon(${points.join(', ')})`;
    }

    function generateRightClipPath(size) {
        let points = ['100% 0', '15% 0'];
        for (let i = 0; i < size; i++) {
            let y1 = (i / size) * 100;
            let y2 = ((i + 0.5) / size) * 100;
            let y3 = ((i + 1) / size) * 100;
            points.push(`15% ${y1}%`, `0% ${y2}%`, `15% ${y3}%`);
        }
        points.push('100% 100%');
        return `polygon(${points.join(', ')})`;
    }

    function addBlock(side, elementName , size) {
        const list = document.getElementById(`${side}-list`);
        if (!list){
            console.error(`List for side "${side}" not found.`);
            return;
        }
        const newBlock = generateBlock(size, side, elementName);
        list.appendChild(newBlock);
        selectBlock(newBlock);  // Auto-select new block
    
    }

    function selectBlock(block) {
        if (selectedBlock) {
            selectedBlock.classList.remove('selected');
        }
        selectedBlock = block;
        if (selectedBlock) {
            selectedBlock.classList.add('selected');
        }
    }

    function changeBlockSize(action) {
        if (!selectedBlock) return;
        let newSize = 0;
        if (selectedSide === "left" && action == 1) {
            currentElem = leftElement[leftElement.length - 1];
            // leftOxidationIndex +=1;
            currentElem[1] += 1
            // newSize = leftList[leftOxidationIndex % leftList.length];
            newSize = currentElem[2][currentElem[1] % currentElem[2].length];
            // console.log(leftOxidationIndex, leftList.length); // Debugging log
            if (newSize < 0) {
                let list = selectedBlock.parentNode;
                let prevBlock = selectedBlock.previousElementSibling;
                selectedBlock.remove();
                selectBlock(prevBlock); // Move selection up
                
                console.log*("New Size:", newSize); // Debugging log
                newSize = Math.abs(newSize);
                // addBlock("right", leftElement, newSize)
                addBlock("right", currentElem[0], newSize)
                selectedSide = "right";
                // rightElement = leftElement;
                // rightList = leftList;
                // leftList = [];
                // leftElement= "";
                // rightOxidationIndex = leftOxidationIndex;
                // leftOxidationIndex = 0;
                rightElement.push(leftElement.pop());


                return
            }
        } else if (selectedSide === "right" && action == 1) {
            currentElem = rightElement[rightElement.length - 1];
            // rightOxidationIndex +=1
            currentElem[1] += 1
            // newSize = rightList[rightOxidationIndex % rightList.length]
            newSize = currentElem[2][currentElem[1] % currentElem[2].length];
            if (newSize > 0) {
                let list = selectedBlock.parentNode;
                let prevBlock = selectedBlock.previousElementSibling;
                selectedBlock.remove();
                selectBlock(prevBlock); // Move selection up


                // addBlock("left", rightElement, newSize)
                addBlock("left", currentElem[0], newSize)
                selectedSide = "left";
                // leftElement = rightElement;
                // leftList = rightList
                // leftOxidationIndex = rightOxidationIndex;
                // rightList = [];
                // rightElement= "";
                // rightOxidationIndex = 0;
                leftElement.push(rightElement.pop());

                return
            }
            newSize = Math.abs(newSize);
        }
        console.log("New Size:", newSize); // Debugging log

        let side = selectedBlock.dataset.side;

        if (action == -1) {
            // Remove block if size reaches 0
            let list = selectedBlock.parentNode;
            let prevBlock = selectedBlock.previousElementSibling;
            selectedBlock.remove();
            selectBlock(prevBlock); // Move selection up
            if (selectedSide === "left") {
                leftOxidationIndex -= 1;
                leftList.splice(leftOxidationIndex, 1);
            } else {
                rightOxidationIndex -= 1;
                rightList.splice(rightOxidationIndex, 1);
            }
        } else {
            selectedBlock.dataset.size = newSize;
            elementName = selectedBlock.dataset.elementName;
            selectedBlock.innerText = side === 'left' ? `${elementName} +${newSize}` : `${elementName} -${newSize}`;
            selectedBlock.style.height = `${(60 * newSize) + ((newSize * newSize) / 2.5)}px`;
            selectedBlock.style.clipPath = side === 'left' ? generateLeftClipPath(newSize) : generateRightClipPath(newSize);
        }
    }

    function selectLatestBlock(side) {
        let list = document.getElementById(`${side}-list`);
        let latestBlock = list.lastElementChild;
        if (latestBlock) selectBlock(latestBlock);
    }

    function parseOxidation(oxStates){
        const oxList = oxStates.split(",").map(num => parseInt(num.trim(), 10));
        return oxList;
    }

    function checkNeutralized(){
        let leftSum = 0;
        let rightSum = 0;
        for (let i = 0; i < leftElement.length; i++){
            oxidationIndex = leftElement[i][1];
            oxidationStates = leftElement[i][2];
            leftSum += oxidationStates[oxidationIndex % oxidationStates.length];
        }
        for (let i = 0; i < rightElement.length; i++){
            oxidationIndex = rightElement[i][1];
            oxidationStates = rightElement[i][2];
            rightSum += oxidationStates[oxidationIndex % oxidationStates.length];
        }
        if (leftSum + rightSum == 0 && leftElement.length > 0 && rightElement.length > 0){
            document.getElementById("neutralized").style.visibility = "visible";
        } else {
            document.getElementById("neutralized").style.visibility = "hidden";
        }
    }

    document.addEventListener('keydown', (event) => {
        if (event.key === 'ArrowLeft') {
            selectLatestBlock('left');
        } else if (event.key === 'ArrowRight') {
            selectLatestBlock('right');
        } else if (event.key === '+' || event.key === '=') {  // `=` is on the same key as `+`
            changeBlockSize(1);
        } else if (event.key === '-') {
            changeBlockSize(-1);
        }
    });

    inputSequence = "";
    maxLength = 32;

    document.addEventListener("keydown", function(event) {
    console.log("Key Pressed:", event.key); // Debugging log

    if (event.key === "Enter" && inputSequence != "") {
        console.log("Final Input Sequence:", inputSequence); // Debugging log
        
        if (inputSequence == "back"){
            getPage("home")
        }
        else {
            //Mock Get Request expected to return dictionary of element or None if invalid
            const element = fetchData("tag-info/" + inputSequence)
            .then(tag => {
            if (tag["Tag Name"]) {
                if (tag["Tag Name"] === "element_info") {
                    getPage('element_info');
                } else if (tag["Tag Name"] === "compare") {
                    getPage('compare');
                } else if (tag["Tag Name"] === "bohr_models") {
                    getPage('bohr_models');
                } else if (tag["Tag Name"] === "ionic_compound") {
                    getPage('ionic_compound');
                } else if (tag["Tag Name"] === "home" || tag["Tag Name"] === "back"){ 
                    getPage('');
                } else if (tag["Tag Name"] === "plus"){
                    changeBlockSize(1);
                    checkNeutralized();
                } else if (tag["Tag Name"] === "minus"){
                    changeBlockSize(-1);
                    checkNeutralized();
                } else if (tag["Tag Name"] === "left_arrow"){
                    selectBlock('left');
                } else if (tag["Tag Name"] === "right_arrow"){
                    selectBlock('right');
                }
            } else if (tag["Element Name"]){
                oxStates = parseOxidation(tag["Oxidation State"]);
                console.log(oxStates);
                firstOxidation = oxStates[0];
                if (firstOxidation > 0){

                    leftElement.push([tag["Element Name"], 0, oxStates]);
                    // leftOxidationIndex = 0;
                    // leftList = oxStates;
                    addBlock("left", leftElement[leftElement.length - 1][0], firstOxidation);
                    selectedSide = "left";
                    checkNeutralized();
                } else if (firstOxidation < 0){
                    rightElement.push([tag["Element Name"], 0, oxStates]);
                    // rightElement = tag["Element Name"];
                    // rightOxidation = 0;
                    // rightList = oxStates;
                    addBlock("right", rightElement[rightElement.length-1][0], Math.abs(firstOxidation));
                    selectedSide = "right";
                    checkNeutralized();
                } else {
                    console.log("⚠️ Invalid Oxidation State. Ignoring input.");
                }
            }
            else{
                console.log("Invalid Input");
            }
            inputSequence = "";
            })
        }
        inputSequence = ""; // Reset sequence after Enter
    } else if (/^[a-zA-Z0-9]$/.test(event.key)) { 
        // Append key only if it's alphanumeric & within limit
        if (inputSequence.length < maxLength) {
            inputSequence += event.key;
        } else {
            console.log("⚠️ Input limit reached (32 chars). Ignoring extra input.");
        }
    }
    });
</script>
